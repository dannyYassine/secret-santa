dist: xenial
os: linux
language: php
cache:
  directories:
    - client/node_modules
    - api/vendor
branches:
  only:
    - main

jobs:
  include:
    - stage: composer-install
      language: php
      php: '7.4.12'
      before_script:
        - cd api
      script: composer install
    - stage: api-test
      language: php
      php: '7.4.12'
      before_script:
        - cd api
        - php artisan key:generate
      script: php artisan test
    - stage: api-deploy
      language: php
      php: '7.4.12'
      script: make deploy-api
    - stage: yarn-install
      language: node_js
      node_js: '14.15.1'
      before_script:
        - cd client
      script: yarn install
    - stage: client-test
      language: node_js
      node_js: '14.15.1'
      before_script:
        - cd client
      script: yarn test
    - stage: client-deploy
      language: node_js
      node_js: '14.15.1'
      before_script:
        - cd client
      script: yarn deploy

stages:
  - composer-install
  - api-test
  - api-deploy
  - yarn-install
  - client-test
  - client-deploy